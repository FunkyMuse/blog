<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Dagger2 is hard, but it can be easy, part 7" /><meta name="author" content="FunkyMuse" /><meta property="og:locale" content="en_US" /><meta name="description" content="Blog containing Kotlin and Android goodies." /><meta property="og:description" content="Blog containing Kotlin and Android goodies." /><link rel="canonical" href="https://funkymuse.github.io/posts/dagger-part-7/" /><meta property="og:url" content="https://funkymuse.github.io/posts/dagger-part-7/" /><meta property="og:site_name" content="FunkyMuse" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-06T23:55:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Dagger2 is hard, but it can be easy, part 7" /><meta name="twitter:site" content="@funky_muse" /><meta name="twitter:creator" content="@FunkyMuse" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"FunkyMuse"},"description":"Blog containing Kotlin and Android goodies.","url":"https://funkymuse.github.io/posts/dagger-part-7/","@type":"BlogPosting","headline":"Dagger2 is hard, but it can be easy, part 7","dateModified":"2021-04-06T23:55:00+02:00","datePublished":"2021-04-06T23:55:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://funkymuse.github.io/posts/dagger-part-7/"},"@context":"https://schema.org"}</script><title>Dagger2 is hard, but it can be easy, part 7 | FunkyMuse</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">FunkyMuse</a></div><div class="site-subtitle font-italic">Anything which inspires everything</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/apps/" class="nav-link"> <i class="fa-fw fas fa-mobile ml-xl-3 mr-xl-3 unloaded"></i> <span>APPLICATIONS</span> </a><li class="nav-item"> <a href="/hire_me/" class="nav-link"> <i class="fa-fw fas fa-code ml-xl-3 mr-xl-3 unloaded"></i> <span>HIRE ME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/FunkyMuse" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/funky_muse" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['funkymuse','protonmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Dagger2 is hard, but it can be easy, part 7</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Dagger2 is hard, but it can be easy, part 7</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> FunkyMuse </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Apr 6, 2021, 11:55 PM +0200" prep="on" > Apr 6 <i class="unloaded">2021-04-06T23:55:00+02:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2569 words">14 min</span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/dagger/dagger_title.jpeg" class="center" /></p><p>In the <a href="/posts/dagger-part-6/">previous</a> post we’ve encountered when’s the right place to inject, named and qualifiers.</p><p>In this post we’ll learn about multi bindings and their power.</p><p>They’re your best buddies in the Dagger world.</p><p>There’s only two of them <code class="language-plaintext highlighter-rouge">Set</code> and <code class="language-plaintext highlighter-rouge">Map</code> multi bindings and as you might’ve guessed they’re indeed collections.</p><p>Go ahead and include</p><div class="language-groovy highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">implementation</span> <span class="s2">"com.squareup.retrofit2:converter-moshi:$retrofit"</span>
<span class="n">implementation</span> <span class="s2">"com.squareup.retrofit2:converter-gson:$retrofit"</span>

<span class="n">implementation</span> <span class="s1">'com.squareup.okhttp3:logging-interceptor:4.9.1'</span>

<span class="n">implementation</span> <span class="s2">"com.squareup.moshi:moshi-kotlin:$moshi"</span>
<span class="n">kapt</span> <span class="s2">"com.squareup.moshi:moshi-kotlin-codegen:$moshi"</span>
</pre></table></code></div></div><p><em>Retrofit’s version at the moment of writing this blog is “2.9.0” and “moshi” is 1.12.0</em></p><p>Go ahead and create a Retrofit module and Interceptors module</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@Module</span>
<span class="kd">object</span> <span class="nc">RetrofitModule</span> <span class="p">{</span>
    
<span class="p">}</span>
</pre></table></code></div></div><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@Module</span>
<span class="kd">object</span> <span class="nc">InterceptorsModule</span><span class="p">{</span>

<span class="p">}</span>
</pre></table></code></div></div><p>don’t forget to include the modules in the singleton component</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@Component</span><span class="p">(</span><span class="n">modules</span> <span class="p">=</span> <span class="p">[</span><span class="nc">RetrofitModule</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="nc">InterceptorsModule</span><span class="o">::</span><span class="k">class</span><span class="p">])</span> <span class="c1">//&lt;-this here</span>
<span class="nd">@Singleton</span>
<span class="kd">interface</span> <span class="nc">SingletonComponent</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
</pre></table></code></div></div><p>Create an interface called <code class="language-plaintext highlighter-rouge">TestApi</code></p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">TestApi</span> <span class="p">{</span>


    <span class="nd">@GET</span><span class="p">(</span><span class="s">"posts"</span><span class="p">)</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getPostsAdapter</span><span class="p">():</span> <span class="nc">Response</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">TestModel</span><span class="p">&gt;&gt;</span>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kd">val</span> <span class="py">BASE_URL</span> <span class="p">=</span> <span class="s">"https://jsonplaceholder.typicode.com/"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>and a <code class="language-plaintext highlighter-rouge">TestModel</code> which will get the response from the url</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nn">com.squareup.moshi.Json</span>
<span class="k">import</span> <span class="nn">com.squareup.moshi.JsonClass</span>

<span class="nd">@JsonClass</span><span class="p">(</span><span class="n">generateAdapter</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
<span class="kd">data class</span> <span class="nc">TestModel</span><span class="p">(</span>
    <span class="nd">@Json</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"body"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">body</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@Json</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"id"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span>
    <span class="nd">@Json</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"title"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">title</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@Json</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"userId"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">userId</span><span class="p">:</span> <span class="nc">Int</span>
<span class="p">)</span>
</pre></table></code></div></div><p><em>we’re using moshi codegen for the json transformation</em></p><p>Let’s create some <code class="language-plaintext highlighter-rouge">Intereceptor</code>s</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">ContentTypeInterceptor</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">contentType</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">"application/json"</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Interceptor</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="nc">Interceptor</span><span class="p">.</span><span class="nc">Chain</span><span class="p">):</span> <span class="nc">Response</span> <span class="p">=</span> <span class="n">chain</span>
            <span class="p">.</span><span class="nf">proceed</span><span class="p">(</span><span class="nf">with</span><span class="p">(</span><span class="n">chain</span><span class="p">.</span><span class="nf">request</span><span class="p">().</span><span class="nf">newBuilder</span><span class="p">())</span> <span class="p">{</span>
                <span class="nf">header</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="n">contentType</span><span class="p">).</span><span class="nf">build</span><span class="p">()</span>
            <span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">EmptyInterceptor</span> <span class="p">:</span> <span class="nc">Interceptor</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="nc">Interceptor</span><span class="p">.</span><span class="nc">Chain</span><span class="p">):</span> <span class="nc">Response</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="nf">proceed</span><span class="p">(</span><span class="n">chain</span><span class="p">.</span><span class="nf">request</span><span class="p">())</span>
<span class="p">}</span>
</pre></table></code></div></div><p>A bootleg retry interceptor</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">RetryRequestInterceptor</span> <span class="p">:</span> <span class="nc">Interceptor</span> <span class="p">{</span>

    <span class="nd">@Throws</span><span class="p">(</span><span class="nc">IOException</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="nc">Interceptor</span><span class="p">.</span><span class="nc">Chain</span><span class="p">):</span> <span class="nc">Response</span> <span class="p">{</span>

        <span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="nf">request</span><span class="p">()</span>
        <span class="kd">var</span> <span class="py">response</span><span class="p">:</span> <span class="nc">Response</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="nf">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="kd">var</span> <span class="py">tryCount</span> <span class="p">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="p">(!</span><span class="n">response</span><span class="p">.</span><span class="n">isSuccessful</span> <span class="p">&amp;&amp;</span> <span class="n">tryCount</span> <span class="p">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tryCount</span><span class="p">++</span>
            <span class="n">response</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="nf">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">response</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>and</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">UnauthorizedInterceptor</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">customMessage</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Authenticator</span> <span class="p">{</span>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">unAuthorized</span> <span class="p">=</span> <span class="mi">401</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">route</span><span class="p">:</span> <span class="nc">Route</span><span class="p">?,</span> <span class="n">response</span><span class="p">:</span> <span class="nc">Response</span><span class="p">):</span> <span class="nc">Request</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(!</span><span class="n">response</span><span class="p">.</span><span class="n">isSuccessful</span> <span class="p">&amp;&amp;</span> <span class="n">response</span><span class="p">.</span><span class="n">code</span> <span class="p">==</span> <span class="n">unAuthorized</span><span class="p">)</span>
            <span class="k">throw</span> <span class="nc">UnauthorizedException</span><span class="p">(</span><span class="n">customMessage</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">request</span>
    <span class="p">}</span>

    <span class="kd">class</span> <span class="nc">UnauthorizedException</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">customMessage</span><span class="p">:</span> <span class="nc">String</span><span class="p">?)</span> <span class="p">:</span> <span class="nc">IOException</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">override</span> <span class="kd">val</span> <span class="py">message</span><span class="p">:</span> <span class="nc">String</span>
            <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">customMessage</span> <span class="o">?:</span> <span class="s">"Un-authorized, please check credentials or re-login/authorize"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Let’s populate our <code class="language-plaintext highlighter-rouge">Retrofit</code> module</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="nd">@Module</span>
<span class="kd">object</span> <span class="nc">RetrofitModule</span> <span class="p">{</span>


    <span class="nd">@Singleton</span>
    <span class="nd">@Provides</span>
    <span class="k">fun</span> <span class="nf">moshiConverterFactory</span><span class="p">()</span> <span class="p">=</span> <span class="nc">MoshiConverterFactory</span><span class="p">.</span><span class="nf">create</span><span class="p">()</span>


    <span class="nd">@Singleton</span>
    <span class="nd">@Provides</span>
    <span class="k">fun</span> <span class="nf">okHttpClientConfiguration</span><span class="p">(</span>
        <span class="n">interceptors</span><span class="p">:</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="err">@</span><span class="nc">JvmSuppressWildcards</span> <span class="nc">Interceptor</span><span class="p">&gt;</span>
    <span class="p">):</span> <span class="nc">OkHttpClient</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">timeout</span> <span class="p">=</span> <span class="mi">10L</span> <span class="c1">//even this can be provided</span>
        <span class="kd">val</span> <span class="py">timeUnit</span> <span class="p">=</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="nc">SECONDS</span> <span class="c1">//even this too, but for the sake of keeping this short we  aren't</span>
        <span class="kd">val</span> <span class="py">client</span> <span class="p">=</span> <span class="nc">OkHttpClient</span><span class="p">().</span><span class="nf">newBuilder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">apply</span> <span class="p">{</span>
                <span class="nf">connectTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">timeUnit</span><span class="p">)</span>
                <span class="nf">callTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">timeUnit</span><span class="p">)</span>
                <span class="nf">readTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">timeUnit</span><span class="p">)</span>
                <span class="nf">writeTimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">timeUnit</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="n">interceptors</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span>
            <span class="n">client</span><span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">client</span><span class="p">.</span><span class="nf">build</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@Provides</span>
    <span class="nd">@Singleton</span>
    <span class="k">fun</span> <span class="nf">retrofitClient</span><span class="p">(</span>
        <span class="n">moshiConverterFactory</span><span class="p">:</span> <span class="nc">MoshiConverterFactory</span><span class="p">,</span>
        <span class="n">okHttpClient</span><span class="p">:</span> <span class="nc">OkHttpClient</span>
    <span class="p">)</span> <span class="p">=</span> <span class="nc">Retrofit</span><span class="p">.</span><span class="nc">Builder</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">addConverterFactory</span><span class="p">(</span><span class="n">moshiConverterFactory</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="n">okHttpClient</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">baseUrl</span><span class="p">(</span><span class="nc">TestApi</span><span class="p">.</span><span class="nc">BASE_URL</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">build</span><span class="p">().</span><span class="n">create</span><span class="p">&lt;</span><span class="nc">TestApi</span><span class="p">&gt;()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>and our <code class="language-plaintext highlighter-rouge">Interceptors</code> module</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nd">@Module</span>
<span class="kd">object</span> <span class="nc">InterceptorsModule</span> <span class="p">{</span>

    <span class="nd">@Provides</span>
    <span class="nd">@IntoSet</span>
    <span class="nd">@Singleton</span>
    <span class="k">fun</span> <span class="nf">contentTypeInterceptor</span><span class="p">()</span> <span class="p">=</span> <span class="nc">ContentTypeInterceptor</span><span class="p">()</span>

    <span class="nd">@Provides</span>
    <span class="nd">@IntoSet</span>
    <span class="nd">@Singleton</span>
    <span class="k">fun</span> <span class="nf">unauthorizedInterceptor</span><span class="p">()</span> <span class="p">=</span> <span class="nc">UnauthorizedInterceptor</span><span class="p">()</span>

    <span class="nd">@Provides</span>
    <span class="nd">@IntoSet</span>
    <span class="nd">@Singleton</span>
    <span class="k">fun</span> <span class="nf">emptyInterceptor</span><span class="p">()</span> <span class="p">=</span> <span class="nc">EmptyInterceptor</span><span class="p">()</span>

    <span class="nd">@Provides</span>
    <span class="nd">@IntoSet</span>
    <span class="nd">@Singleton</span>
    <span class="k">fun</span> <span class="nf">retryInterceptor</span><span class="p">()</span> <span class="p">=</span> <span class="nc">RetryRequestInterceptor</span><span class="p">()</span>

    <span class="nd">@Provides</span>
    <span class="nd">@Singleton</span>
    <span class="nd">@IntoSet</span>
    <span class="c1">//this one we don't create don't be confused</span>
    <span class="k">fun</span> <span class="nf">httpLoggingInterceptor</span><span class="p">()</span> <span class="p">:</span><span class="nc">Interceptor</span> <span class="p">=</span> <span class="nc">HttpLoggingInterceptor</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
        <span class="n">level</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="nc">BuildConfig</span><span class="p">.</span><span class="nc">DEBUG</span><span class="p">)</span> <span class="nc">HttpLoggingInterceptor</span><span class="p">.</span><span class="nc">Level</span><span class="p">.</span><span class="nc">BODY</span> <span class="k">else</span> <span class="nc">HttpLoggingInterceptor</span><span class="p">.</span><span class="nc">Level</span><span class="p">.</span><span class="nc">NONE</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="set">Set</h2><hr /><p>The aforementioned example is just creating a Retrofit Client that’s all, the new comer you’re seeing here is <code class="language-plaintext highlighter-rouge">@IntoSet</code></p><p>Once you get creating a multi module project, the <code class="language-plaintext highlighter-rouge">Set</code> multibindings (@Intoset) is really coming in handy, especially when decoupling of the implementation by the type you’re gonna use.</p><p>It can scale from so called <code class="language-plaintext highlighter-rouge">Initializers</code>(that hide away the initialization logic), <code class="language-plaintext highlighter-rouge">Adapters</code> that bind some data and in our example <code class="language-plaintext highlighter-rouge">Interceptor</code>s and it doesn’t stop here…</p><p>What <code class="language-plaintext highlighter-rouge">@IntoSet</code> does is, it creates a <code class="language-plaintext highlighter-rouge">Set</code> for you of the type you’re providing, in this example you can <em>also</em> levarage the set for providing the <code class="language-plaintext highlighter-rouge">MoshiConverterFactory</code> with some <code class="language-plaintext highlighter-rouge">Adapters</code> of your own that can lie in a separate module called <code class="language-plaintext highlighter-rouge">:moshi-adapters</code> or whatever you named them, but for the sake of this example let’s keep it short, hopefully by now you’ve realized the power.</p><p>The part that you should know is that if you’ve provided one thing into the <strong>graph</strong> you can use it as a parameter into a function.</p><p>As you see our Client configuration function that provides an <code class="language-plaintext highlighter-rouge">OkHttpClient</code></p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">fun</span> <span class="nf">okHttpClientConfiguration</span><span class="p">(</span>
        <span class="n">interceptors</span><span class="p">:</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="err">@</span><span class="nc">JvmSuppressWildcards</span> <span class="nc">Interceptor</span><span class="p">&gt;</span>
    <span class="p">)</span>
</pre></table></code></div></div><p>accepts set of interceptors from other Dagger module (<code class="language-plaintext highlighter-rouge">InterceptorsModule</code>) but they’re brought together with <code class="language-plaintext highlighter-rouge">@Component(modules = [RetrofitModule::class, InterceptorsModule::class])</code>, also there’s this <code class="language-plaintext highlighter-rouge">@JvmSuppressWildcards</code>, the <a href="https://kotlinlang.org/docs/java-to-kotlin-interop.html#variant-generics">explanation</a> of why’s this happening can be a bit confusing, let’s keep it simple:</p><ol><li>We’re injecting <code class="language-plaintext highlighter-rouge">Set&lt;Interceptor&gt;</code>, what Kotlin does is it generates Java code<li>The java code looks like <code class="language-plaintext highlighter-rouge">Set&lt;? extends Interceptor&gt;</code> where as you know <code class="language-plaintext highlighter-rouge">?</code> is a <a href="https://docs.oracle.com/javase/tutorial/extra/generics/wildcards.html">wild card</a>, Dagger gets confused<li>If we add <code class="language-plaintext highlighter-rouge">@JvmSuppressWildcards</code> that generated code gets transformed into <code class="language-plaintext highlighter-rouge">Set&lt;Interceptor&gt;</code> and Dagger isn’t confused anymore into the Kotlin world.</ol><p>Now this approach of Set gets to keep your <code class="language-plaintext highlighter-rouge">Interceptor</code>s into a separate module and this scales really good because all you have to do is include a parameter of Set in your function that provides a dependency maybe coming from a module that you once wrote and reused at multiple times with other modules than our <code class="language-plaintext highlighter-rouge">IntereceptorsModule</code>.</p><h2 id="map">Map</h2><hr /><p><code class="language-plaintext highlighter-rouge">@IntoMap</code> binds a provided dependency into a Map collection using a key, Dagger comes with:</p><ol><li><code class="language-plaintext highlighter-rouge">@StringKey</code> annotation which binds a dependency to a <code class="language-plaintext highlighter-rouge">String</code> key<li><code class="language-plaintext highlighter-rouge">@ClassKey</code> which binds it to a class<li><code class="language-plaintext highlighter-rouge">@MapKey</code> for keys that are of type enums or parameterized classes (your own)</ol><p>Go ahead and create a <code class="language-plaintext highlighter-rouge">TestViewModel</code></p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">TestViewModel</span> <span class="nd">@Inject</span> <span class="k">constructor</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">testApi</span><span class="p">:</span> <span class="nc">TestApi</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">listData</span><span class="p">:</span> <span class="nc">MutableStateFlow</span><span class="p">&lt;</span><span class="nc">SimpleResult</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">TestModel</span><span class="p">&gt;&gt;&gt;</span> <span class="p">=</span> <span class="nc">MutableStateFlow</span><span class="p">(</span><span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">Loading</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">list</span> <span class="p">=</span> <span class="n">listData</span><span class="p">.</span><span class="nf">asStateFlow</span><span class="p">()</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="n">viewModelScope</span><span class="p">.</span><span class="nf">launch</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">listData</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="k">try</span> <span class="p">{</span>
                <span class="nf">transformPosts</span><span class="p">(</span><span class="n">testApi</span><span class="p">.</span><span class="nf">getPostsAdapter</span><span class="p">())</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">throwable</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">{</span>
                <span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">Exception</span><span class="p">(</span><span class="n">throwable</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">transformPosts</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="nc">Response</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">TestModel</span><span class="p">&gt;&gt;):</span> <span class="nc">SimpleResult</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">TestModel</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">isSuccessful</span><span class="p">)</span> <span class="p">{</span>
            <span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">Success</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">()</span> <span class="o">?:</span> <span class="nf">emptyList</span><span class="p">())</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">ApiError</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">code</span><span class="p">(),</span> <span class="n">response</span><span class="p">.</span><span class="nf">errorBody</span><span class="p">())</span>
        <span class="p">}</span>


    <span class="k">sealed</span> <span class="kd">class</span> <span class="nc">SimpleResult</span><span class="p">&lt;</span><span class="k">out</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">data class</span> <span class="nc">Exception</span><span class="p">(</span><span class="kd">val</span> <span class="py">throwable</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">:</span> <span class="nc">SimpleResult</span><span class="p">&lt;</span><span class="nc">Nothing</span><span class="p">&gt;()</span>
        <span class="kd">data class</span> <span class="nc">ApiError</span><span class="p">(</span><span class="kd">val</span> <span class="py">responseCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="kd">val</span> <span class="py">errorBody</span><span class="p">:</span> <span class="nc">ResponseBody</span><span class="p">?)</span> <span class="p">:</span> <span class="nc">SimpleResult</span><span class="p">&lt;</span><span class="nc">Nothing</span><span class="p">&gt;()</span>
        <span class="kd">data class</span> <span class="nc">Success</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;(</span><span class="kd">val</span> <span class="py">data</span><span class="p">:</span> <span class="nc">T</span><span class="p">)</span> <span class="p">:</span> <span class="nc">SimpleResult</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;()</span>
        <span class="kd">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="nc">SimpleResult</span><span class="p">&lt;</span><span class="nc">Nothing</span><span class="p">&gt;()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We’re including our <code class="language-plaintext highlighter-rouge">testApi : TestApi</code> using constructor injection and just calling an api to get the result, don’t forget to add the <code class="language-plaintext highlighter-rouge">Internet</code> permission <code class="language-plaintext highlighter-rouge">&lt;uses-permission android:name="android.permission.INTERNET"/&gt;</code> inside your manifest.</p><p>Before you move onto the next part add</p><div class="language-groovy highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">implementation</span> <span class="s2">"androidx.lifecycle:lifecycle-runtime-ktx:$lifecycle"</span>
</pre></table></code></div></div><p>where “lifecycle” is ‘2.4.0-alpha01’ or better, to add a way to collect flows safely without leaking resources by using <code class="language-plaintext highlighter-rouge">addRepeatingJob</code>.</p><p>For the sake of this demonstration into your <code class="language-plaintext highlighter-rouge">activity_main.xml</code></p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;androidx.constraintlayout.widget.ConstraintLayout</span>
    <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
    <span class="na">android:layout_height=</span><span class="s">"match_parent"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;androidx.fragment.app.FragmentContainerView</span>
        <span class="na">android:id=</span><span class="s">"@+id/fragment_container"</span>
        <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
        <span class="na">android:layout_height=</span><span class="s">"match_parent"</span> <span class="nt">/&gt;</span>
    
<span class="nt">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span>
</pre></table></code></div></div><p>inside <code class="language-plaintext highlighter-rouge">MainActivity</code></p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="nf">addOnContextAvailableListener</span> <span class="p">{</span> <span class="n">availableContext-</span><span class="p">&gt;</span>
            <span class="nf">injector</span> <span class="p">{</span>
                <span class="nf">activityComponentFactory</span><span class="p">().</span><span class="nf">create</span><span class="p">(</span><span class="n">availableContext</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">inject</span><span class="p">(</span><span class="k">this</span><span class="nd">@MainActivity</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Inject</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">powerReceiver</span><span class="p">:</span> <span class="nc">PowerReceiver</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">filter</span> <span class="p">=</span> <span class="nc">IntentFilter</span><span class="p">(</span><span class="nc">Intent</span><span class="p">.</span><span class="nc">ACTION_POWER_CONNECTED</span><span class="p">).</span><span class="nf">also</span> <span class="p">{</span>
            <span class="n">it</span><span class="p">.</span><span class="nf">addAction</span><span class="p">(</span><span class="nc">Intent</span><span class="p">.</span><span class="nc">ACTION_POWER_DISCONNECTED</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nf">registerReceiver</span><span class="p">(</span><span class="n">powerReceiver</span><span class="p">,</span><span class="n">filter</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">savedInstanceState</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">supportFragmentManager</span>
                <span class="p">.</span><span class="nf">beginTransaction</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">fragment_container</span><span class="p">,</span> <span class="nc">HomeFragment</span><span class="p">(),</span> <span class="s">"HomeFragment"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><p>Inside your <code class="language-plaintext highlighter-rouge">HomeFragment</code></p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">HomeFragment</span> <span class="p">:</span> <span class="nc">Fragment</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">home_fragment</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAttach</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">injector</span> <span class="p">{</span>
            <span class="nf">fragmentComponentFactory</span><span class="p">().</span><span class="nf">create</span><span class="p">().</span><span class="nf">inject</span><span class="p">(</span><span class="k">this</span><span class="nd">@HomeFragment</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onAttach</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">testViewModel</span> <span class="k">by</span> <span class="n">viewModels</span><span class="p">&lt;</span><span class="nc">TestViewModel</span><span class="p">&gt;()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onViewCreated</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="nc">View</span><span class="p">,</span> <span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onViewCreated</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="n">viewLifecycleOwner</span><span class="p">.</span><span class="nf">addRepeatingJob</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">State</span><span class="p">.</span><span class="nc">STARTED</span><span class="p">){</span>
            <span class="n">testViewModel</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="nf">collect</span> <span class="p">{</span>
                <span class="nf">handleAPICall</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handleAPICall</span><span class="p">(</span><span class="n">simpleResult</span><span class="p">:</span> <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">TestModel</span><span class="p">&gt;&gt;)</span> <span class="p">{</span>
        <span class="k">when</span><span class="p">(</span><span class="n">simpleResult</span><span class="p">){</span>
            <span class="k">is</span> <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">ApiError</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"SimpleResult.ApiError"</span><span class="p">,</span> <span class="s">"Response code ${simpleResult.responseCode}"</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">is</span> <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">Exception</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="k">when</span><span class="p">(</span><span class="n">simpleResult</span><span class="p">.</span><span class="n">throwable</span><span class="p">){</span>
                   <span class="k">is</span> <span class="nc">UnauthorizedInterceptor</span><span class="p">.</span><span class="nc">UnauthorizedException-</span><span class="p">&gt;{</span>
                       <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"Exception"</span><span class="p">,</span> <span class="s">"Log off"</span><span class="p">)</span>
                   <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">Loading</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"SimpleResult.Loading"</span><span class="p">,</span> <span class="s">"SHOW SPINNER"</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">is</span> <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">Success</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="kd">val</span> <span class="py">successData</span> <span class="p">=</span> <span class="n">simpleResult</span><span class="p">.</span><span class="n">data</span>
                <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"SimpleResult.Success"</span><span class="p">,</span> <span class="n">successData</span><span class="p">.</span><span class="nf">toString</span><span class="p">())</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>now you’re ready to run the application, once you do that</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">RuntimeException</span><span class="o">:</span> <span class="nc">Cannot</span> <span class="n">create</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="kd">class</span> <span class="nc">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">TestViewModel</span>
</pre></table></code></div></div><p>You might ask yourself why, what did I do wrong? Nothing, it’s Android again complicating things…</p><p>The ViewModel can’t be created because Dagger doesn’t know how to provide the dependency to that particular ViewModel of ours, as you know that ViewModels are created by a <code class="language-plaintext highlighter-rouge">ViewModelProvider.Factory</code> we need to tell Dagger about that somehow and also provide a way for it to know how to create our <code class="language-plaintext highlighter-rouge">TestViewModel</code>, which is where <code class="language-plaintext highlighter-rouge">Map</code> multi bindings shine.</p><p>First, we need a key that will provide us a class that inherits from <code class="language-plaintext highlighter-rouge">ViewModel</code></p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nd">@MustBeDocumented</span>
<span class="nd">@Target</span><span class="p">(</span>
    <span class="nc">AnnotationTarget</span><span class="p">.</span><span class="nc">FUNCTION</span><span class="p">,</span>
    <span class="nc">AnnotationTarget</span><span class="p">.</span><span class="nc">PROPERTY_GETTER</span><span class="p">,</span>
    <span class="nc">AnnotationTarget</span><span class="p">.</span><span class="nc">PROPERTY_SETTER</span>
<span class="p">)</span>
<span class="nd">@MapKey</span>
<span class="k">annotation</span> <span class="kd">class</span> <span class="nc">ViewModelKey</span><span class="p">(</span><span class="kd">val</span> <span class="py">kotlinClassKey</span><span class="p">:</span> <span class="nc">KClass</span><span class="p">&lt;</span><span class="k">out</span> <span class="nc">ViewModel</span><span class="p">&gt;)</span>
</pre></table></code></div></div><p>as you can see as we’ve mentioned before that class has a <code class="language-plaintext highlighter-rouge">@MapKey</code> which means it’s something specialized for our use case. The <code class="language-plaintext highlighter-rouge">@Target</code> is specialized where do we apply that annotation to, in our case means that we need to use <code class="language-plaintext highlighter-rouge">@Provides</code> on a function in a module, the key is of a <code class="language-plaintext highlighter-rouge">KClass</code> that has a <code class="language-plaintext highlighter-rouge">out</code> which is a covariant that can accept every kotlin class name that inherits from <code class="language-plaintext highlighter-rouge">ViewModel</code> (we’re restricting this to ViewModel only, instead we could’ve just used Any, but we don’t need that because we might have another key of type Any and confusion… confusion).</p><p>Secondly we need a <code class="language-plaintext highlighter-rouge">ViewModel.Factory</code></p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@Suppress</span><span class="p">(</span><span class="s">"UNCHECKED_CAST"</span><span class="p">)</span>
<span class="nd">@Singleton</span>
<span class="kd">class</span> <span class="nc">DaggerViewModelFactory</span> <span class="nd">@Inject</span> <span class="k">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">viewModelMap</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">Class</span><span class="p">&lt;</span><span class="k">out</span> <span class="nc">ViewModel</span><span class="p">&gt;,</span> <span class="err">@</span><span class="nc">JvmSuppressWildcards</span> <span class="nc">Provider</span><span class="p">&lt;</span><span class="nc">ViewModel</span><span class="p">&gt;&gt;</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModelProvider</span><span class="p">.</span><span class="nc">Factory</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">&gt;</span> <span class="nf">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="nc">Class</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">T</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">creator</span> <span class="p">=</span> <span class="n">viewModelMap</span><span class="p">[</span><span class="n">modelClass</span><span class="p">]</span> <span class="o">?:</span> <span class="n">viewModelMap</span><span class="p">.</span><span class="n">entries</span><span class="p">.</span><span class="nf">firstOrNull</span> <span class="p">{</span>
            <span class="n">modelClass</span><span class="p">.</span><span class="nf">isAssignableFrom</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>
        <span class="p">}</span><span class="o">?.</span><span class="n">value</span> <span class="o">?:</span> <span class="k">throw</span> <span class="nc">IllegalArgumentException</span><span class="p">(</span><span class="s">"Unable to locate class $modelClass"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">creator</span><span class="p">.</span><span class="k">get</span><span class="p">()</span> <span class="k">as</span> <span class="nc">T</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Thirdly we need a module</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nd">@Module</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">ViewModelModule</span> <span class="p">{</span>
    <span class="nd">@Binds</span>
    <span class="nd">@IntoMap</span>
    <span class="nd">@ViewModelKey</span><span class="p">(</span><span class="nc">TestViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
    <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">bindTestViewModel</span><span class="p">(</span><span class="n">testViewModel</span><span class="p">:</span> <span class="nc">TestViewModel</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModel</span>

    <span class="nd">@Binds</span>
    <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">bindViewModelFactory</span><span class="p">(</span><span class="n">factory</span><span class="p">:</span> <span class="nc">DaggerViewModelFactory</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModelProvider</span><span class="p">.</span><span class="nc">Factory</span>
<span class="p">}</span>
</pre></table></code></div></div><p>You might ask yourself why an abstract class, because the abstract class only accepts an implementation of dependencies which we did already in our case this is <code class="language-plaintext highlighter-rouge">TestViewModel</code> and we return it as a <code class="language-plaintext highlighter-rouge">: ViewModel</code> because our <code class="language-plaintext highlighter-rouge">@IntoMap</code> expects a type of <code class="language-plaintext highlighter-rouge">Provider&lt;ViewModel&gt;&gt;</code> and of course we tell Dagger that the map it gives to our <code class="language-plaintext highlighter-rouge">DaggerViewModelFactory</code> has to have <code class="language-plaintext highlighter-rouge">TestViewModel::class</code> so that it can create our <code class="language-plaintext highlighter-rouge">TestViewModel</code> later on.</p><p>For example if you have a class</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Car</span> <span class="p">()</span> <span class="p">:</span> <span class="nc">Vehicle</span>
</pre></table></code></div></div><p>and</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">Vehicle</span>
</pre></table></code></div></div><p>inside your abstract module you can do</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nd">@Module</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">CarsModule</span> <span class="p">{</span>
    <span class="nd">@Binds</span>
    <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">bindCar</span><span class="p">(</span><span class="n">car</span><span class="p">:</span> <span class="nc">Car</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Vehicle</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">@Binds</code> works nearly the same as <code class="language-plaintext highlighter-rouge">@Provides</code> which can only provide dependencies of abstract functions that you already have an implementation for and the way it creates them is way more effecient than <code class="language-plaintext highlighter-rouge">@Provides</code>, which means try to use <code class="language-plaintext highlighter-rouge">@Binds</code> as much as you can, clean architecture picture in 3…2…1… <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/dagger/7/clean_code.jpeg" class="center" /></p><p>You might not be familiar with why <code class="language-plaintext highlighter-rouge">Provider</code> is used in this case, sometimes you need multiple instances of the same type to be returned instead of just injecting a single value, meaning that you can have that <code class="language-plaintext highlighter-rouge">TestViewModel</code> inside a <code class="language-plaintext highlighter-rouge">HomeFragment</code>, <code class="language-plaintext highlighter-rouge">LoginFragment</code> and <code class="language-plaintext highlighter-rouge">YourNameHereFragment</code> etc… etc.. As we’ve talked into <a href="/posts/dagger-part-1/">part 1</a>, Dagger is really one interface and that’s <code class="language-plaintext highlighter-rouge">Provider</code> which has only one function called <code class="language-plaintext highlighter-rouge">get()</code> which gets the dependency.</p><p>let’s go step by step:</p><ol><li>Every view model factory inherits from <code class="language-plaintext highlighter-rouge">ViewModelProvider.Factory</code> which has only one <code class="language-plaintext highlighter-rouge">create()</code> method and that method has a parameter of a <code class="language-plaintext highlighter-rouge">modelClass: Class&lt;T&gt;</code> which is our custom map key<li>Since we have the key from step one, now we need to <code class="language-plaintext highlighter-rouge">@Inject</code> the map where we have the Key that’s of our class for the ViewModel and a provider which’ll give us an instance of that ViewModel<li>We access the <code class="language-plaintext highlighter-rouge">viewModelMap[modelClass]</code> that means we might not have a value for that key, we traverse the map and we check if <code class="language-plaintext highlighter-rouge">modelClass.isAssignableFrom(it.key)</code>, meaning that they’re either the same types and we just access the value using <code class="language-plaintext highlighter-rouge">.value</code><li><code class="language-plaintext highlighter-rouge">creator</code> is of a type <code class="language-plaintext highlighter-rouge">Provider&lt;ViewModule&gt;</code> which returned our <code class="language-plaintext highlighter-rouge">ViewModel</code> and all we need to do is call <code class="language-plaintext highlighter-rouge">creator.get()</code> as we’ve discussed that Providers have only one function<li>We cast it as <code class="language-plaintext highlighter-rouge">T</code> because the <code class="language-plaintext highlighter-rouge">create()</code> function expects a typed parameter</ol><p>With this we’ve created a generic <code class="language-plaintext highlighter-rouge">ViewModelProvider.Factory</code> that we can use now to create our <code class="language-plaintext highlighter-rouge">TestViewModel</code></p><p>Now we need to head out for our <code class="language-plaintext highlighter-rouge">SingletonComponent</code> and include the <code class="language-plaintext highlighter-rouge">ViewModelModule</code></p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nd">@Component</span><span class="p">(</span><span class="n">modules</span> <span class="p">=</span> <span class="p">[</span><span class="nc">RetrofitModule</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="nc">InterceptorsModule</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="nc">ViewModelModule</span><span class="o">::</span><span class="k">class</span><span class="p">])</span>
<span class="nd">@Singleton</span>
<span class="kd">interface</span> <span class="nc">SingletonComponent</span> <span class="p">{</span>
    <span class="p">.</span>
    <span class="p">.</span>
    <span class="p">.</span>

<span class="p">}</span>
</pre></table></code></div></div><p>The only thing we need to change now in our <code class="language-plaintext highlighter-rouge">HomeFragment</code> is</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@Inject</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">daggerViewModelFactory</span><span class="p">:</span> <span class="nc">ViewModelProvider</span><span class="p">.</span><span class="nc">Factory</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">testViewModel</span> <span class="k">by</span> <span class="n">viewModels</span><span class="p">&lt;</span><span class="nc">TestViewModel</span><span class="p">&gt;(){</span>
        <span class="n">daggerViewModelFactory</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>which means now dagger knows how to create our ViewModel using the factory we created leveraging the <code class="language-plaintext highlighter-rouge">by viewModels</code> delegate that expects a creator of a type factory.</p><p>Our <code class="language-plaintext highlighter-rouge">HomeFragment</code> can look like</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">HomeFragment</span> <span class="p">:</span> <span class="nc">Fragment</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">home_fragment</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAttach</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">injector</span> <span class="p">{</span>
            <span class="nf">fragmentComponentFactory</span><span class="p">().</span><span class="nf">create</span><span class="p">().</span><span class="nf">inject</span><span class="p">(</span><span class="k">this</span><span class="nd">@HomeFragment</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onAttach</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Inject</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">daggerViewModelFactory</span><span class="p">:</span> <span class="nc">ViewModelProvider</span><span class="p">.</span><span class="nc">Factory</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">testViewModel</span> <span class="k">by</span> <span class="n">viewModels</span><span class="p">&lt;</span><span class="nc">TestViewModel</span><span class="p">&gt;(){</span>
        <span class="n">daggerViewModelFactory</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onViewCreated</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="nc">View</span><span class="p">,</span> <span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onViewCreated</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="n">viewLifecycleOwner</span><span class="p">.</span><span class="nf">addRepeatingJob</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">State</span><span class="p">.</span><span class="nc">STARTED</span><span class="p">){</span>
            <span class="n">testViewModel</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="nf">collect</span> <span class="p">{</span>
                <span class="nf">handleAPICall</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handleAPICall</span><span class="p">(</span><span class="n">simpleResult</span><span class="p">:</span> <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">TestModel</span><span class="p">&gt;&gt;)</span> <span class="p">{</span>
        <span class="k">when</span><span class="p">(</span><span class="n">simpleResult</span><span class="p">){</span>
            <span class="k">is</span> <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">ApiError</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"SimpleResult.ApiError"</span><span class="p">,</span> <span class="s">"Response code ${simpleResult.responseCode}"</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">is</span> <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">Exception</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="k">when</span><span class="p">(</span><span class="n">simpleResult</span><span class="p">.</span><span class="n">throwable</span><span class="p">){</span>
                   <span class="k">is</span> <span class="nc">UnauthorizedInterceptor</span><span class="p">.</span><span class="nc">UnauthorizedException-</span><span class="p">&gt;{</span>
                       <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"Exception"</span><span class="p">,</span> <span class="s">"Log off"</span><span class="p">)</span>
                   <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">Loading</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"SimpleResult.Loading"</span><span class="p">,</span> <span class="s">"SHOW SPINNER"</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">is</span> <span class="nc">TestViewModel</span><span class="p">.</span><span class="nc">SimpleResult</span><span class="p">.</span><span class="nc">Success</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="kd">val</span> <span class="py">successData</span> <span class="p">=</span> <span class="n">simpleResult</span><span class="p">.</span><span class="n">data</span>
                <span class="nc">Log</span><span class="p">.</span><span class="nf">d</span><span class="p">(</span><span class="s">"SimpleResult.Success"</span><span class="p">,</span> <span class="n">successData</span><span class="p">.</span><span class="nf">toString</span><span class="p">())</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Run it and it works.</p><p>You might think there’s nothing wrong with this but there actually is, everything is scoped to <code class="language-plaintext highlighter-rouge">@Singleton</code>, also getting a <code class="language-plaintext highlighter-rouge">SavedStateHandle</code> requires to use <code class="language-plaintext highlighter-rouge">AssistedInject</code> that requires a lot of changing which won’t matter once we start using <em>Hilt</em> from the next part as this is sufficient for today and this blog post is longer than I anticipated also every bit of this informations needs some time for you to stomach it.</p><p>From the next blog post, we’re jumping onto the <strong>Hilt</strong> train and see where it goes, also <strong>Hilt</strong> in a nutshell <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/dagger/7/hilt.jpeg" class="center" /></p><p>Thank you again for your wholehearted attention and stay tuned for the Hilt blog series.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/dagger/'>Dagger</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/dagger/" class="post-tag no-text-decoration" >Dagger</a> <a href="/tags/kotlin/" class="post-tag no-text-decoration" >Kotlin</a> <a href="/tags/android/" class="post-tag no-text-decoration" >Android</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Dagger2 is hard, but it can be easy, part 7 - FunkyMuse&url=https://funkymuse.github.io/posts/dagger-part-7/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Dagger2 is hard, but it can be easy, part 7 - FunkyMuse&u=https://funkymuse.github.io/posts/dagger-part-7/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Dagger2 is hard, but it can be easy, part 7 - FunkyMuse&url=https://funkymuse.github.io/posts/dagger-part-7/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://funkymuse.github.io/posts/dagger-part-7/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://www.reddit.com/submit?url=https://funkymuse.github.io/posts/dagger-part-7/&title=Dagger2 is hard, but it can be easy, part 7 - FunkyMuse" data-toggle="tooltip" data-placement="top" title="Reddit" target="_blank" rel="noopener" aria-label="Reddit"> <i class="fa-fw fab fa-reddit"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/dagger/">Dagger</a> <a class="post-tag" href="/tags/hilt/">Hilt</a> <a class="post-tag" href="/tags/gradle/">Gradle</a> <a class="post-tag" href="/tags/architecture-components/">Architecture Components</a> <a class="post-tag" href="/tags/compose/">Compose</a> <a class="post-tag" href="/tags/jetpack/">Jetpack</a> <a class="post-tag" href="/tags/optimizations/">Optimizations</a> <a class="post-tag" href="/tags/programming/">Programming</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/dagger-part-5/"><div class="card-body"> <span class="timeago small" > Mar 29 <i class="unloaded">2021-03-29T22:45:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dagger2 is hard, but it can be easy, part 5</h3><div class="text-muted small"><p> In the previous post we’ve explored scope operators. In this post we’ll encounter subcomponents and their hierarchy, custom scopes and let’s not waste any time. Starting off by including the an...</p></div></div></a></div><div class="card"> <a href="/posts/dagger-part-6/"><div class="card-body"> <span class="timeago small" > Apr 2 <i class="unloaded">2021-04-02T20:05:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dagger2 is hard, but it can be easy, part 6</h3><div class="text-muted small"><p> In the previous post we’ve encountered subcomponents and their hierarchy, custom scopes and we did not waste any time. In this post we’ll learn when’s the right place to inject, named and qualif...</p></div></div></a></div><div class="card"> <a href="/posts/dagger-part-1/"><div class="card-body"> <span class="timeago small" > Mar 1 <i class="unloaded">2021-03-01T15:46:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dagger2 is hard, but it can be easy, part 1</h3><div class="text-muted small"><p> One day you decided to use Dagger2 and then you were lost, don’t worry, most of us were already there, Dagger2 is easy, you’ll see, it’s literally one interface, let’s start. A little bit of his...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/dagger-part-6/" class="btn btn-outline-primary" prompt="Older"><p>Dagger2 is hard, but it can be easy, part 6</p></a> <a href="/posts/hilt-part-1/" class="btn btn-outline-primary" prompt="Newer"><p>Hilt to the rescue, part 1</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/funky_muse">FunkyMuse</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."> Some rights reserved. </span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/dagger/">Dagger</a> <a class="post-tag" href="/tags/hilt/">Hilt</a> <a class="post-tag" href="/tags/gradle/">Gradle</a> <a class="post-tag" href="/tags/architecture-components/">Architecture Components</a> <a class="post-tag" href="/tags/compose/">Compose</a> <a class="post-tag" href="/tags/jetpack/">Jetpack</a> <a class="post-tag" href="/tags/optimizations/">Optimizations</a> <a class="post-tag" href="/tags/programming/">Programming</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://funkymuse.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
