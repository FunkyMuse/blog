<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Reified, crossinline, noinline and inline everything?" /><meta name="author" content="FunkyMuse" /><meta property="og:locale" content="en_US" /><meta name="description" content="Blog containing Kotlin and Android goodies." /><meta property="og:description" content="Blog containing Kotlin and Android goodies." /><link rel="canonical" href="https://funkymuse.github.io/posts/reified-crossinline-noinline-and-inline/" /><meta property="og:url" content="https://funkymuse.github.io/posts/reified-crossinline-noinline-and-inline/" /><meta property="og:site_name" content="FunkyMuse" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-01T15:46:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Reified, crossinline, noinline and inline everything?" /><meta name="twitter:site" content="@funky_muse" /><meta name="twitter:creator" content="@FunkyMuse" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"FunkyMuse"},"description":"Blog containing Kotlin and Android goodies.","url":"https://funkymuse.github.io/posts/reified-crossinline-noinline-and-inline/","@type":"BlogPosting","headline":"Reified, crossinline, noinline and inline everything?","dateModified":"2021-02-01T15:46:00+01:00","datePublished":"2021-02-01T15:46:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://funkymuse.github.io/posts/reified-crossinline-noinline-and-inline/"},"@context":"https://schema.org"}</script><title>Reified, crossinline, noinline and inline everything? | FunkyMuse</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">FunkyMuse</a></div><div class="site-subtitle font-italic">Anything which inspires everything</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/apps/" class="nav-link"> <i class="fa-fw fas fa-mobile ml-xl-3 mr-xl-3 unloaded"></i> <span>APPLICATIONS</span> </a><li class="nav-item"> <a href="/hire_me/" class="nav-link"> <i class="fa-fw fas fa-code ml-xl-3 mr-xl-3 unloaded"></i> <span>HIRE ME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/FunkyMuse" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/funky_muse" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['funkymuse','protonmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Reified, crossinline, noinline and inline everything?</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Reified, crossinline, noinline and inline everything?</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> FunkyMuse </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Feb 1, 2021, 3:46 PM +0100" prep="on" > Feb 1 <i class="unloaded">2021-02-01T15:46:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1156 words">6 min</span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://www.mememaker.net/static/images/memes/4773372.jpg" class="center" /></p><p>This is a continuation of the previous <a href="/posts/higher-order-functions/">blog post</a>.</p><p>As promised this is the blog post where we’ll talk more about the mysterious inline, crossinline and not so confusing noinline and my most favorite, reified.</p><h2 id="inlining">Inlining</h2><hr /><p>What is inlining?</p><p>Let’s say you have a</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">open</span> <span class="kd">class</span> <span class="nc">Dog</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">bark</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// call printBarkMessage</span>
        <span class="nf">printBarkMessage</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">printBarkMessage</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">println</span><span class="p">(</span><span class="s">"meow, ughhm woof?"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Inlining</strong> is a way to optimize compiled source code at runtime with the help of the JIT (just in time compiler) by replacing the invocations of the most often executed methods with their bodies.</p><p>When inline happens we have the following</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">open</span> <span class="kd">class</span> <span class="nc">Dog</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">bark</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// call printBarkMessage</span>
        <span class="nf">println</span><span class="p">(</span><span class="s">"meow, ughhm woof?"</span><span class="p">)</span> <span class="p">&lt;----</span> <span class="n">inlining</span> <span class="n">hpapens</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">printBarkMessage</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">println</span><span class="p">(</span><span class="s">"meow, ughhm woof?"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>If another class was to extend Dog then we have to make our printBarkMessage() open and override it and we have</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Husky</span> <span class="p">:</span> <span class="nc">Dog</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">printBarkMessage</span><span class="p">(){</span>
        <span class="nf">println</span><span class="p">(</span><span class="s">"woofz and more woofz"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>then essentially when inlining happens, the compiler will be stuck with the</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">fun</span> <span class="nf">printBarkMessage</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">println</span><span class="p">(</span><span class="s">"meow, ughhm woof?"</span><span class="p">)</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>which would be wrong in this case, since the object was actually an instance of <strong>Husky</strong>.</p><p>Well this is Java’s world, which applies to Kotlin but with some smart decisions done by the Kotlin team.</p><p>If we were to add inline modifier to printBarkMessage and override the printBarkMessage in our <strong>Husky</strong> class we’d get</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4/1.png" /></p><p>it suggests you to make it open, but even if you do <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4/2.png" /></p><p>you can’t inline it, Kotlin has solved the problem for us but does it end here?</p><p>Not quite.</p><p>In case you want only some of the lambdas passed to an inline function to be inlined, you can mark some of your function parameters with the noinline modifier:</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">inline</span> <span class="k">fun</span> <span class="nf">bragAboutHowIAmUsingLinux</span><span class="p">(</span><span class="n">arch</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">,</span> <span class="k">noinline</span> <span class="n">ubuntu</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">)</span> <span class="p">{</span> <span class="o">..</span><span class="p">.</span> <span class="p">}</span>
</pre></table></code></div></div><p>If we were to write this function</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">inline</span> <span class="k">fun</span> <span class="nf">stopUsingJava</span><span class="p">(</span><span class="n">body</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">migrateToKotlinRunnable</span> <span class="p">=</span> <span class="nc">Runnable</span> <span class="p">{</span> <span class="nf">body</span><span class="p">()</span> <span class="p">}</span> <span class="p">&lt;---</span> <span class="n">won</span><span class="err">'</span><span class="n">t</span> <span class="n">compile</span>
    <span class="n">migrateToKotlinRunnable</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>but why it doesn’t compile?</p><p>First, an inline function that call the lambdas passed to it as parameters not directly from the function body, can’t return out of a nested lambda, first let’s take a look of a case where you can return</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">fun</span> <span class="nf">hasBitcoin</span><span class="p">(</span><span class="n">listOfNames</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">Boolean</span> <span class="p">{</span>
    <span class="n">listOfNames</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="p">==</span> <span class="s">"Elon Musk"</span><span class="p">)</span> <span class="k">return</span> <span class="k">true</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">false</span>
<span class="p">}</span>
</pre></table></code></div></div><p>this isn’t an inlined function and it’s body is not copy pasted around as an inline would and the compiler knows about its return and it’s not nested inside another lambda (forEach is an only one) but forEach is a lambda, now how do we fix stopUsingJava?</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">inline</span> <span class="k">fun</span> <span class="nf">stopUsingJava</span><span class="p">(</span><span class="k">crossinline</span> <span class="n">body</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">migrateToKotlinRunnable</span> <span class="p">=</span> <span class="nc">Runnable</span> <span class="p">{</span> <span class="nf">body</span><span class="p">()</span> <span class="p">}</span>
    <span class="n">migrateToKotlinRunnable</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="inlining-explanations">Inlining explanations</h2><hr /><p>Since body can’t do non local returns and the function is an inlined one, body has to be marked with crossinline, you requested to copy-paste the code of the block into a place that expects a value by doing so it can’t contain non-local control flow, what does this mean? You can’t use return.</p><p>Inlining does some pretty good optimizations when all functional type parameters are called directly or passed to other inline function/s and if at least one of your functional type parameters can be inlined, use noinline for the others.</p><p>Another use case is reified type parameters, which require you to use inline (you’re forced to inline them), but why?</p><p>For example</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nc">String</span><span class="p">.</span><span class="nf">toKotlinObject</span><span class="p">():</span> <span class="nc">T</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">mapper</span> <span class="p">=</span> <span class="nf">myCustomObjectMapper</span><span class="p">()</span> <span class="c1">//does not compile!</span>
    <span class="k">return</span> <span class="n">mapper</span><span class="p">.</span><span class="nf">mapPojoValue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nc">T</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">inline</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="k">reified</span> <span class="nc">T</span><span class="p">:</span> <span class="nc">Any</span><span class="p">&gt;</span> <span class="nc">String</span><span class="p">.</span><span class="nf">toKotlinObject</span><span class="p">():</span> <span class="nc">T</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">mapper</span> <span class="p">=</span> <span class="nf">myCustomObjectMapper</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mapper</span><span class="p">.</span><span class="nf">mapPojoValue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nc">T</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Alright, what’s happening here?</p><p>You tell the compiler to copy the function’s body (bytecode) to every line the function is invoked from (also known as inlining) from there on when you combine an inline function with reified type, the compiler knows the actual type passed as a type argument so that it can modify the generated bytecode to use the corresponding class directly.</p><p>If you have a call like myVariableFromServer is <code class="language-plaintext highlighter-rouge">T</code> becomes <code class="language-plaintext highlighter-rouge">myVariableFromServer</code> is <strong>Husky</strong> in the bytecode (if the type argument is <strong>Husky</strong>).</p><p>But how does this happen actually?</p><p>You probably heard of the interface <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Type.html">Type</a>, which is the superinterface of all types in the JVM.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4/3.png" class="center" /></p><p>As you can see Class is implementing this interface</p><p>If you access an</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">Any</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="n">genericSuperClass</span>
</pre></table></code></div></div><p>it returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Type.html">Type</a>, but Type won’t do us any good since it only hold a name describing itself but we can cast the Type to a <strong>ParameterizedType</strong>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4/4.png" class="center" /></p><p>and now we have an array of actual type arguments that hold the object representing the actualy type argument, we need the first object only.</p><h2 id="type">Type</h2><hr /><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kd">val</span> <span class="py">type</span><span class="p">:</span> <span class="nc">Type</span><span class="p">?</span>
    <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="p">(</span><span class="k">this</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="n">genericSuperclass</span> <span class="k">as</span> <span class="nc">ParameterizedType</span><span class="p">).</span><span class="n">actualTypeArguments</span><span class="p">.</span><span class="nf">firstOrNull</span><span class="p">()</span>
</pre></table></code></div></div><p>and now if we were to have the class information for a String it will print out</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span>
</pre></table></code></div></div><p>and that’s how reified was born.</p><p>We have learned about inlining and reified and now every time you think of passing a lambda to your function (apart from being forced to use inline when you need the type parameter) you think of inlining it huh? I don’t blame you, your brain tricks you into inlining it just as it did tricked me.</p><p>Why won’t you need to do that? As explained in the previous blog post</p><p>Additionaly JVM has <strong><em>limits</em></strong> of up to <strong>64K</strong> bytecode instructions for a single method, careful how you tread with inlining, it can be something you’re proud of, with great abstraction comes great overhead, either for you as a programmer or for the compiler.</p><p>Hope you learned something new today. Back to writing Kotlin.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/1/4.jpg" class="center" /></p><p>You can inline properties you know?</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kd">val</span> <span class="py">foo</span><span class="p">:</span> <span class="nc">Fighters</span>
    <span class="k">inline</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="nc">Fighters</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">var</span> <span class="py">system</span><span class="p">:</span> <span class="nc">OfADown</span>
    <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>
<span class="k">inline</span> <span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="o">..</span><span class="p">.</span> <span class="p">}</span>
</pre></table></code></div></div><p>or the whole property which marks both the getter and the setter as inlined</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">inline</span> <span class="kd">var</span> <span class="py">tool</span><span class="p">:</span> <span class="nc">Tool</span>
    <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>
    <span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="o">..</span><span class="p">.</span> <span class="p">}</span>
</pre></table></code></div></div><p>also when you have an internal property value annotate it with</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nd">@PublishedApi</span>
</pre></table></code></div></div><p>so that you can use it inside an inlined function.</p><p>And also a function, constructor and a class can be marked with @PublishedApi, then instead of internal they’re public for the inlined functions.</p><p>From today’s knowledge we can write a simple exercise for an infamous event provider.</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">object</span> <span class="nc">RxBus</span> <span class="p">{</span>

    <span class="nd">@PublishedApi</span>
    <span class="k">internal</span> <span class="kd">val</span> <span class="py">publisher</span> <span class="p">=</span> <span class="nc">PublishSubject</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">&gt;()</span>

    <span class="k">fun</span> <span class="nf">publish</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nc">Any</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">publisher</span><span class="p">.</span><span class="nf">onNext</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">inline</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="k">reified</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="nf">listen</span><span class="p">():</span> <span class="nc">Observable</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">publisher</span><span class="p">.</span><span class="nf">ofType</span><span class="p">(</span><span class="nc">T</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>

<span class="p">}</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4/6.jpg" class="center" /></p><p>P.S: sometimes I write good code</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kotlin/'>Kotlin</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kotlin/" class="post-tag no-text-decoration" >Kotlin</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Reified, crossinline, noinline and inline everything? - FunkyMuse&url=https://funkymuse.github.io/posts/reified-crossinline-noinline-and-inline/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Reified, crossinline, noinline and inline everything? - FunkyMuse&u=https://funkymuse.github.io/posts/reified-crossinline-noinline-and-inline/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Reified, crossinline, noinline and inline everything? - FunkyMuse&url=https://funkymuse.github.io/posts/reified-crossinline-noinline-and-inline/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://funkymuse.github.io/posts/reified-crossinline-noinline-and-inline/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://www.reddit.com/submit?url=https://funkymuse.github.io/posts/reified-crossinline-noinline-and-inline/&title=Reified, crossinline, noinline and inline everything? - FunkyMuse" data-toggle="tooltip" data-placement="top" title="Reddit" target="_blank" rel="noopener" aria-label="Reddit"> <i class="fa-fw fab fa-reddit"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/dagger/">Dagger</a> <a class="post-tag" href="/tags/hilt/">Hilt</a> <a class="post-tag" href="/tags/gradle/">Gradle</a> <a class="post-tag" href="/tags/architecture-components/">Architecture Components</a> <a class="post-tag" href="/tags/compose/">Compose</a> <a class="post-tag" href="/tags/jetpack/">Jetpack</a> <a class="post-tag" href="/tags/optimizations/">Optimizations</a> <a class="post-tag" href="/tags/programming/">Programming</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/dagger-part-5/"><div class="card-body"> <span class="timeago small" > Mar 29 <i class="unloaded">2021-03-29T22:45:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dagger2 is hard, but it can be easy, part 5</h3><div class="text-muted small"><p> In the previous post we’ve explored scope operators. In this post we’ll encounter subcomponents and their hierarchy, custom scopes and let’s not waste any time. Starting off by including the an...</p></div></div></a></div><div class="card"> <a href="/posts/dagger-part-6/"><div class="card-body"> <span class="timeago small" > Apr 2 <i class="unloaded">2021-04-02T20:05:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dagger2 is hard, but it can be easy, part 6</h3><div class="text-muted small"><p> In the previous post we’ve encountered subcomponents and their hierarchy, custom scopes and we did not waste any time. In this post we’ll learn when’s the right place to inject, named and qualif...</p></div></div></a></div><div class="card"> <a href="/posts/dagger-part-7/"><div class="card-body"> <span class="timeago small" > Apr 6 <i class="unloaded">2021-04-06T23:55:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dagger2 is hard, but it can be easy, part 7</h3><div class="text-muted small"><p> In the previous post we’ve encountered when’s the right place to inject, named and qualifiers. In this post we’ll learn about multi bindings and their power. They’re your best buddies in the Da...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/higher-order-functions/" class="btn btn-outline-primary" prompt="Older"><p>Higher order functions, how, why and what not to do.</p></a> <a href="/posts/dagger-part-1/" class="btn btn-outline-primary" prompt="Newer"><p>Dagger2 is hard, but it can be easy, part 1</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/funky_muse">FunkyMuse</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."> Some rights reserved. </span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/dagger/">Dagger</a> <a class="post-tag" href="/tags/hilt/">Hilt</a> <a class="post-tag" href="/tags/gradle/">Gradle</a> <a class="post-tag" href="/tags/architecture-components/">Architecture Components</a> <a class="post-tag" href="/tags/compose/">Compose</a> <a class="post-tag" href="/tags/jetpack/">Jetpack</a> <a class="post-tag" href="/tags/optimizations/">Optimizations</a> <a class="post-tag" href="/tags/programming/">Programming</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://funkymuse.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
